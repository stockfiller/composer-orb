version: 2.1
description: Handle PHP packages using Composer
display:
    home_url: https://stockfiller.com
    source_url: https://github.com/stockfiller/composer-orb
commands:
    install:
        description: Install Composer dependencies
        parameters:
            cache-version:
                default: v1
                description: Bump to invalidate cache
                type: string
            classmap-authoritative:
                default: false
                description: Autoload classes from the classmap only. Implicitly enables --optimize-autoloader
                type: boolean
            ignore-platform-reqs:
                default: true
                description: Ignore all platform requirements (php & ext- packages)
                type: boolean
            no-dev:
                default: false
                description: Disables installation of require-dev packages
                type: boolean
            no-scripts:
                default: true
                description: Skips the execution of all scripts defined in composer.json file
                type: boolean
            optimize-autoloader:
                default: false
                description: Optimize autoloader during autoloader dump
                type: boolean
            prefer-dist:
                default: true
                description: Forces installation from package dist even for dev versions
                type: boolean
        steps:
            -   when:
                    condition: << parameters.cache-version >>
                    steps:
                        -   restore_cache:
                                keys:
                                    - << parameters.cache-version >>-composer-{{ checksum "composer.lock" }}
                                    - << parameters.cache-version >>-composer
            -   run:
                    name: Install Composer dependencies
                    command: composer install --no-interaction ${COMPOSER_FLAGS}
                    environment:
                        COMPOSER_FLAGS: >-
                            <<# parameters.prefer-dist >> --prefer-dist <</ parameters.prefer-dist >>
                            <<# parameters.no-scripts >> --no-scripts <</ parameters.no-scripts >>
                            <<# parameters.ignore-platform-reqs >> --ignore-platform-reqs <</ parameters.ignore-platform-reqs >>
                            <<# parameters.no-dev >> --no-dev <</ parameters.no-dev >>
                            <<# parameters.classmap-authoritative >> --classmap-authoritative <</ parameters.classmap-authoritative >>
                            <<# parameters.optimize-autoloader >> --optimize-autoloader <</ parameters.optimize-autoloader >>
            -   when:
                    condition: << parameters.cache-version >>
                    steps:
                        -   save_cache:
                                key: << parameters.cache-version >>-composer-{{ checksum "composer.lock" }}
                                paths:
                                    - vendor
                                    - ~/.composer/cache
